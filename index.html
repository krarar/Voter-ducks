<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="icon" type="image/png" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/Gemini_Generated_Image_4wnx844wnx844wnx.png?alt=media&token=a10c597c-9643-4169-93c0-40b30cedbed5">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تطبيق الانتخابات - صوتك مستقبلك</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/Gemini_Generated_Image_4wnx844wnx844wnx.png?alt=media&token=a10c597c-9643-4169-93c0-40b30cedbed5">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap');
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --primary-light: #6366F1;
            --secondary: #8B5CF6;
            --accent: #F59E0B;
            --success: #10B981;
            --bg-gradient: linear-gradient(135deg, #4F46E5 0%, #8B5CF6 100%);
            --card-bg: #FFFFFF;
            --info-bg: #F8FAFC;
            --text-dark: #1E293B;
            --text-light: #64748B;
            --border: #E2E8F0;
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #EEF2FF 0%, #F3E8FF 50%, #FEF3C7 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* شاشة الانتظار */
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-gradient);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .splash-logo {
            width: 140px;
            height: 140px;
            border-radius: 32px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: pulse 2s ease-in-out infinite;
            margin-bottom: 30px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .splash-text {
            color: white;
            text-align: center;
            max-width: 90%;
        }

        .splash-text h1 {
            font-size: 1.8em;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .splash-text p {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            opacity: 0;
            animation: fadeInUp 1s ease-out 0.5s forwards;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .splash-text .quote {
            font-size: 0.95em;
            font-weight: 400;
            opacity: 0;
            animation: fadeInUp 1s ease-out 1s forwards;
            line-height: 1.5;
        }

        .loading-spinner {
            margin-top: 30px;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Container */
        .container {
            width: 100%;
            max-width: 100%;
            padding: 15px;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            text-align: center;
            padding: 15px 0;
            margin-bottom: 20px;
        }

        .app-logo {
            width: 70px;
            height: 70px;
            border-radius: 18px;
            margin: 0 auto 15px;
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.3);
        }

        h2 {
            text-align: center;
            margin-bottom: 8px;
            background: var(--bg-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.8em;
            font-weight: 900;
        }

        .subtitle {
            text-align: center;
            color: var(--text-light);
            font-size: 0.95em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* Form Card */
        .form-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            margin-bottom: 15px;
        }

        label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: var(--text-dark);
            font-weight: 700;
            font-size: 0.9em;
        }

        input, select {
            width: 100%;
            padding: 12px 14px;
            margin-bottom: 15px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--info-bg);
            font-size: 0.95em;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            border-color: var(--primary);
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        input[type="file"] {
            padding: 10px;
            cursor: pointer;
            border: 2px dashed var(--primary);
            font-size: 0.85em;
        }

        /* Button */
        button {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            border: none;
            background: var(--bg-gradient);
            color: white;
            font-size: 1.05em;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
        }

        button:active {
            transform: scale(0.98);
        }

        .link {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: var(--primary);
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9em;
            text-decoration: none;
        }

        /* بطاقة الناخب - التصميم الجديد */
        .voter-card {
            background: var(--card-bg);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .card-header {
            background: var(--bg-gradient);
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .card-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
        }

        .card-logo {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: white;
            padding: 5px;
        }

        .card-title {
            flex: 1;
            text-align: center;
        }

        .card-title h3 {
            color: white;
            font-size: 1.3em;
            font-weight: 900;
            margin: 0;
        }

        .card-title p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85em;
            margin: 5px 0 0 0;
            font-weight: 600;
        }

        .verified-badge {
            width: 28px;
            height: 28px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1em;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .card-body {
            padding: 20px;
        }

        .profile-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--info-bg);
        }

        .profile-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--info-bg);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            flex-shrink: 0;
        }

        .profile-name {
            flex: 1;
        }

        .profile-name h4 {
            color: var(--text-dark);
            font-size: 1.3em;
            font-weight: 900;
            margin-bottom: 5px;
        }

        .profile-name .phone {
            color: var(--text-light);
            font-size: 0.95em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* ID Card Display */
        .id-card-display {
            margin: 20px 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border: 3px solid var(--info-bg);
        }

        .id-card-display img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* معلومات المرشح */
        .candidate-section {
            background: var(--bg-gradient);
            border-radius: 16px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .candidate-section .icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .candidate-section h4 {
            color: white;
            font-size: 0.9em;
            font-weight: 700;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .candidate-section p {
            color: white;
            font-size: 1.15em;
            font-weight: 900;
            margin: 0;
        }

        /* معلومات المستخدم */
        .user-info {
            display: grid;
            gap: 12px;
        }

        .info-item {
            background: var(--info-bg);
            border-radius: 14px;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .info-icon {
            width: 42px;
            height: 42px;
            background: var(--bg-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .info-content {
            flex: 1;
            min-width: 0;
        }

        .info-label {
            color: var(--text-light);
            font-weight: 600;
            font-size: 0.8em;
            margin-bottom: 2px;
        }

        .info-value {
            color: var(--text-dark);
            font-weight: 800;
            font-size: 0.95em;
            word-wrap: break-word;
        }

        /* Logout Button */
        .logout-btn {
            margin-top: 20px;
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }

        /* Install Button */
        .install-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-gradient);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 0.95em;
            font-weight: 800;
            z-index: 9998;
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.4);
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }

        /* Responsive */
        @media (max-width: 360px) {
            h2 { font-size: 1.5em; }
            .splash-text h1 { font-size: 1.5em; }
            .profile-name h4 { font-size: 1.1em; }
            .card-title h3 { font-size: 1.1em; }
        }

        @media (min-width: 768px) {
            .container {
                max-width: 480px;
                margin: 0 auto;
                padding: 20px;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body>
    <!-- شاشة الانتظار -->
    <div id="splash">
        <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/Gemini_Generated_Image_4wnx844wnx844wnx.png?alt=media&token=a10c597c-9643-4169-93c0-40b30cedbed5" alt="شعار التطبيق" class="splash-logo">
        <div class="splash-text">
            <h1>🗳️ صوتك اليوم هو مستقبلك غداً</h1>
            <p>معاً نبني عراقاً أفضل</p>
            <p class="quote">"المشاركة في الانتخابات مسؤولية وطنية"</p>
        </div>
        <div class="loading-spinner"></div>
    </div>

    <div class="container" id="app" style="display:none;"></div>

    <script>
        // تسجيل service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js');
            });
        }

        // إخفاء شاشة الانتظار
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.getElementById('splash').style.opacity = '0';
                document.getElementById('splash').style.transition = 'opacity 0.5s ease';
                setTimeout(function() {
                    document.getElementById('splash').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                }, 500);
            }, 2500);
        });

        // زر التثبيت
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            let installBtn = document.createElement('button');
            installBtn.textContent = '📱 ثبّت التطبيق';
            installBtn.className = 'install-button';
            installBtn.onclick = function() {
                installBtn.style.display = 'none';
                deferredPrompt.prompt();
            };
            document.body.appendChild(installBtn);
        });

        // قوائم البيانات
        const qadaList = [
            'الحلة', 'الكفل', 'أبي غرق', 'سنجار',
            'الهاشمية', 'القاسم', 'المدحتية', 'الشوملي', 'الطليعة',
            'المحاويل', 'المشروع', 'الإمام', 'النيل',
            'المسيب', 'الإسكندرية', 'سدة الهندية', 'جرف الصخر'
        ];

        const candidateList = [
            "سيد حسين السعبري", "حمزه جبار حربي محمد", "عدي اركان عباس نعمان",
            "عصام فخري برتو عويد", "احمد بدر جاسم حسین", "اکرام کامل ظاهر محسن",
            "ميثم عبد الجاسم عبد الحمزه", "فرح احمد کامل درب", "محمد جواد عبد الكاظم",
            "تحسين فليح حسن عبود", "حسين كامل ناجي معيدي", "حميد حمزه کاظم مسیر",
            "ابتسام حسن ذياب مرزوقي", "اسیل خالد عبد محمد", "محمد هادي كاظم جواد",
            "سلام عبد الكاظم عبد الله", "ثائر عبد اللطيف عبد الحميد", "زهره محمد سعود عزیز",
            "مرزة حمزة عبدمعين", "عمر خضير عباس كسار", "زينب عباس علي لطيف",
            "زهير عباس عبود رزوقي", "الاء عبد الكاظم عباس", "غيث علي سميسم عبيد",
            "ياسر عامر صبار محيسن", "كريم سعد حسين لوطان", "نداء طالب محسن ثاجب",
            "أسماء حسين جدوع کاظم", "زهير جواد ناجي عباس", "احمد سلمان عوده بريو",
            "سعود حسن جمعة مطر"
        ];

        // إعدادات Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "messageemeapp.firebaseapp.com",
            databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
            projectId: "messageemeapp",
            storageBucket: "messageemeapp.appspot.com",
            messagingSenderId: "255034474844",
            appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199",
            measurementId: "G-4QBEWRC583"
        };

        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = typeof firebase !== 'undefined' ? firebase.database() : null;

        // وظائف المساعدة
        function saveUser(user) {
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            users.push(user);
            localStorage.setItem('users', JSON.stringify(users));
            if (db) {
                db.ref('users/' + user.phone).set(user, function(error) {
                    if (error) {
                        alert('حدث خطأ: ' + error.message);
                    } else {
                        alert('تم حفظ بياناتك بنجاح! 🎉');
                    }
                });
            }
        }

        function findUser(name, phone) {
            let users = JSON.parse(localStorage.getItem('users') || '[]');
            return users.find(u => u.fullName === name && u.phone === phone);
        }

        // واجهة تسجيل الدخول
        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <div class="app-header">
                    <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/Gemini_Generated_Image_4wnx844wnx844wnx.png?alt=media&token=a10c597c-9643-4169-93c0-40b30cedbed5" alt="شعار" class="app-logo">
                </div>
                <h2>تسجيل الدخول</h2>
                <p class="subtitle">مرحباً بك في نظام الانتخابات</p>
                <div class="form-card">
                    <form id="loginForm">
                        <label>👤 الاسم الثلاثي</label>
                        <input type="text" name="fullName" placeholder="أدخل اسمك الكامل" required>
                        <label>📱 رقم الهاتف</label>
                        <input type="text" name="phone" placeholder="07XX XXX XXXX" required>
                        <button type="submit">دخول 🚀</button>
                    </form>
                </div>
                <span class="link" onclick="renderRegister()">ليس لديك حساب؟ أنشئ حساب جديد</span>
            `;
            document.getElementById('loginForm').onsubmit = function(e) {
                e.preventDefault();
                const fullName = this.fullName.value.trim();
                const phone = this.phone.value.trim();
                const user = findUser(fullName, phone);
                if (user) {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    renderUserData(user);
                } else {
                    alert('⚠️ لا يوجد مستخدم بهذه البيانات!');
                }
            };
        }

        // واجهة إنشاء حساب
        function renderRegister() {
            document.getElementById('app').innerHTML = `
                <div class="app-header">
                    <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/Gemini_Generated_Image_4wnx844wnx844wnx.png?alt=media&token=a10c597c-9643-4169-93c0-40b30cedbed5" alt="شعار" class="app-logo">
                </div>
                <h2>إنشاء حساب جديد</h2>
                <p class="subtitle">انضم إلى نظام الانتخابات</p>
                <div class="form-card">
                    <form id="registerForm">
                        <label>👤 الاسم الثلاثي</label>
                        <input type="text" name="fullName" placeholder="أدخل اسمك الكامل" required>
                        <label>📱 رقم الهاتف</label>
                        <input type="text" name="phone" placeholder="07XX XXX XXXX" required>
                        <label>📅 تاريخ الميلاد</label>
                        <input type="date" name="birthDate" required>
                        <label>📍 القضاء</label>
                        <select name="district" required>
                            <option value="">-- اختر القضاء --</option>
                            ${qadaList.map(q => `<option value="${q}">${q}</option>`).join('')}
                        </select>
                        <label>⚧️ الجنس</label>
                        <select name="gender" required>
                            <option value="ذكر">ذكر</option>
                            <option value="أنثى">أنثى</option>
                        </select>
                        <label>🎯 اسم المرشح</label>
                        <select name="candidate" required>
                            <option value="">-- اختر المرشح --</option>
                            ${candidateList.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                        <label>📝 ملاحظات (اختياري)</label>
                        <input type="text" name="notes" placeholder="أضف ملاحظاتك هنا">
                        <label>📸 الصورة الأمامية</label>
                        <input type="file" name="front" accept="image/*" required>
                        <button type="submit">إنشاء الحساب ✨</button>
                    </form>
                </div>
                <span class="link" onclick="renderLogin()">لديك حساب؟ تسجيل الدخول</span>
            `;
            document.getElementById('registerForm').onsubmit = function(e) {
                e.preventDefault();
                const fullName = this.fullName.value.trim();
                const phone = this.phone.value.trim();
                const birthDate = this.birthDate.value;
                const district = this.district.value;
                const gender = this.gender.value;
                const candidate = this.candidate.value;
                const notes = this.notes.value.trim();
                const frontFile = this.front.files[0];
                
                if (!frontFile || !candidate) {
                    alert('⚠️ يرجى إكمال جميع الحقول المطلوبة');
                    return;
                }
                
                const storageRef = firebase.storage().ref();
                const fileRef = storageRef.child('user-images/' + phone + '_front_' + Date.now() + '.webp');
                fileRef.put(frontFile).then(snapshot => {
                    return snapshot.ref.getDownloadURL();
                }).then(downloadURL => {
                    const user = {
                        fullName, phone, birthDate, district, gender, candidate, notes,
                        images: { front: downloadURL },
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    saveUser(user);
                    renderUserData(user);
                }).catch(err => {
                    alert('❌ فشل رفع الصورة: ' + err.message);
                });
            };
        }

        // عرض بيانات المستخدم
        function renderUserData(user) {
            document.getElementById('app').innerHTML = `
                <div class="app-header">
                    <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/Gemini_Generated_Image_4wnx844wnx844wnx.png?alt=media&token=a10c597c-9643-4169-93c0-40b30cedbed5" alt="شعار" class="app-logo">
                </div>
                
                <div class="voter-card">
                    <div class="card-header">
                        <div class="card-header-content">
                            <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/Gemini_Generated_Image_4wnx844wnx844wnx.png?alt=media&token=a10c597c-9643-4169-93c0-40b30cedbed5" alt="logo" class="card-logo">
                            <div class="card-title">
                                <h3>بطاقة الناخب</h3>
                                <p>معلومات المستخدم</p>
                            </div>
                            <div class="verified-badge">✓</div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="profile-section">
                            <img id="profileImg" class="profile-img" src="${user.profileImg || (user.images && user.images.front) || ''}" alt="صورة">
                            <div class="profile-name">
                                <h4>${user.fullName}</h4>
                                <div class="phone">📱 ${user.phone}</div>
                            </div>
                        </div>
                        <input type="file" id="profileInput" accept="image/*" capture="environment" style="display:none">
                        
                        <div class="id-card-display">
                            <img src="${user.images && user.images.front || ''}" alt="البطاقة">
                        </div>
                        
                        <div class="candidate-section">
                            <div class="icon">🎯</div>
                            <h4>المرشح المختار</h4>
                            <p>${user.candidate || ''}</p>
                        </div>
                        
                        <div class="user-info">
                            <div class="info-item">
                                <div class="info-icon">📅</div>
                                <div class="info-content">
                                    <div class="info-label">تاريخ الميلاد</div>
                                    <div class="info-value">${user.birthDate}</div>
                                </div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-icon">📍</div>
                                <div class="info-content">
                                    <div class="info-label">القضاء</div>
                                    <div class="info-value">${user.district}</div>
                                </div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-icon">⚧️</div>
                                <div class="info-content">
                                    <div class="info-label">الجنس</div>
                                    <div class="info-value">${user.gender}</div>
                                </div>
                            </div>
                            
                            ${user.notes ? `
                            <div class="info-item">
                                <div class="info-icon">📝</div>
                                <div class="info-content">
                                    <div class="info-label">ملاحظات</div>
                                    <div class="info-value">${user.notes}</div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <button onclick="logoutUser()" class="logout-btn">تسجيل خروج 🚪</button>
            `;
            
            setTimeout(function() {
                var profileInput = document.getElementById('profileInput');
                var profileImg = document.getElementById('profileImg');
                if (profileImg && profileInput) {
                    profileImg.onclick = function() { profileInput.click(); };
                    profileInput.onchange = function(e) {
                        var file = e.target.files[0];
                        if (file) {
                            const storageRef = firebase.storage().ref();
                            const fileRef = storageRef.child('user-profiles/' + user.phone + '_profile_' + Date.now() + '.webp');
                            fileRef.put(file).then(snapshot => snapshot.ref.getDownloadURL())
                            .then(downloadURL => {
                                document.getElementById('profileImg').src = downloadURL;
                                user.profileImg = downloadURL;
                                let users = JSON.parse(localStorage.getItem('users') || '[]');
                                let idx = users.findIndex(u => u.phone === user.phone);
                                if (idx !== -1) {
                                    users[idx].profileImg = downloadURL;
                                    localStorage.setItem('users', JSON.stringify(users));
                                }
                                if (db) {
                                    db.ref('users/' + user.phone + '/profileImg').set(downloadURL);
                                }
                                alert('✅ تم تحديث الصورة بنجاح!');
                            })
                            .catch(err => alert('❌ فشل رفع الصورة: ' + err.message));
                        }
                    };
                }
            }, 100);
        }

        function logoutUser() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                localStorage.removeItem('currentUser');
                renderLogin();
            }
        }

        // بدء التطبيق
        const currentUser = localStorage.getItem('currentUser');
        if (currentUser) {
            renderUserData(JSON.parse(currentUser));
        } else {
            if (typeof db !== 'undefined' && db) {
                db.ref('users').once('value').then(snapshot => {
                    const users = snapshot.val() ? Object.values(snapshot.val()) : [];
                    localStorage.setItem('users', JSON.stringify(users));
                    renderLogin();
                });
            } else {
                renderLogin();
            }
        }
    </script>
</body>
</html>
