<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="icon" type="image/png" href="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/icon-192.png?alt=media&token=8d29fc43-51ea-45f3-a41a-10b8f2e0d9cf">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الهاتف - نظام إدارة البيانات</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        /* نفس الأنماط من التطبيق الأصلي */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1e293b;
            --dark-secondary: #334155;
            --light: #f8fafc;
            --light-secondary: #f1f5f9;
            --bg: #ffffff;
            --bg-secondary: #f8fafc;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --text: #1e293b;
            --text-light: #64748b;
            --text-muted: #94a3b8;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
            --sidebar-width: 280px;
            --header-height: 70px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg) 100%);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }
        .container {
            max-width: 400px;
            margin: 40px auto;
            background: var(--bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            padding: 32px 24px;
        }
        h2 {
            text-align: center;
            margin-bottom: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2em;
            font-weight: 700;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-light);
            font-weight: 500;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 18px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--light-secondary);
            font-size: 1em;
            transition: var(--transition);
        }
        input:focus, select:focus {
            border-color: var(--primary);
            outline: none;
        }
        button {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius);
            border: none;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        button:hover {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .link {
            display: block;
            text-align: center;
            margin-top: 12px;
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
        }
        .user-data {
            background: var(--light-secondary);
            border-radius: var(--radius-lg);
            padding: 28px 18px 18px 18px;
            margin-top: 28px;
            box-shadow: var(--shadow-md);
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
        }
        .flip-card {
            background: transparent;
            width: 220px;
            height: 140px;
            margin: 0 auto 18px auto;
            perspective: 1000px;
            cursor: pointer;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .flip-card-front img, .flip-card-back img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .flip-card-back {
            transform: rotateY(180deg);
        }
        .user-info {
            margin-top: 18px;
            text-align: right;
        }
        .user-info strong {
            color: var(--primary-dark);
            font-weight: 600;
        }
        .user-info span {
            color: var(--text);
            margin-right: 6px;
        }
        
        /* نظام الإشعارات */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            max-width: 350px;
            animation: slideIn 0.3s ease-out;
            font-weight: 500;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .notification.success {
            background: var(--success);
            color: white;
        }
        .notification.error {
            background: var(--danger);
            color: white;
        }
        .notification.warning {
            background: var(--warning);
            color: white;
        }
        .notification.info {
            background: var(--info);
            color: white;
        }
        
        /* حالة التحميل */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* نظام عرض الأخطاء */
        .error-log {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--dark);
            color: var(--light);
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            font-size: 0.9em;
            max-width: 300px;
            box-shadow: var(--shadow-lg);
            z-index: 9999;
            cursor: pointer;
        }
        .error-details {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
            z-index: 10001;
            direction: ltr;
            text-align: left;
        }
        .error-details h3 {
            color: var(--danger);
            margin-bottom: 16px;
        }
        .error-details pre {
            background: var(--light-secondary);
            padding: 12px;
            border-radius: var(--radius-sm);
            overflow-x: auto;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
        }
        
        /* حالة الاتصال */
        .connection-status {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
        }
        .connection-status.online {
            background: var(--success);
            color: white;
        }
        .connection-status.offline {
            background: var(--danger);
            color: white;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- شاشة البداية -->
    <div id="splash" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#fff;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;">
        <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/icon-192.png?alt=media&token=8d29fc43-51ea-45f3-a41a-10b8f2e0d9cf" alt="شعار التطبيق" style="width:180px;height:180px;border-radius:32px;box-shadow:0 4px 24px #6366f155;">
        <div style="margin-top:24px;color:var(--primary);font-size:1.1em;font-weight:600;">جاري التحميل...</div>
        <div class="loading" style="margin-top:16px;border-color:#e2e8f0;border-top-color:#6366f1;"></div>
    </div>
    
    <!-- مؤشر حالة الاتصال -->
    <div id="connectionStatus" class="connection-status" style="display:none;">
        <div class="status-dot"></div>
        <span id="statusText">متصل</span>
    </div>
    
    <!-- الحاوية الرئيسية -->
    <div class="container" id="app" style="display:none;"></div>
    
    <script>
        // ====================================
        // نظام تسجيل الأخطاء المتقدم
        // ====================================
        const ErrorLogger = {
            logs: [],
            maxLogs: 50,
            
            log(type, message, details = null) {
                const timestamp = new Date().toISOString();
                const error = {
                    type,
                    message,
                    details,
                    timestamp,
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                this.logs.unshift(error);
                if (this.logs.length > this.maxLogs) {
                    this.logs.pop();
                }
                
                // حفظ في localStorage
                try {
                    localStorage.setItem('errorLogs', JSON.stringify(this.logs));
                } catch (e) {
                    console.error('فشل حفظ سجلات الأخطاء:', e);
                }
                
                // طباعة في console
                console.error(`[${type}] ${message}`, details || '');
                
                // عرض للمستخدم إذا كان خطأ حرج
                if (type === 'CRITICAL' || type === 'ERROR') {
                    this.showErrorToUser(message);
                }
            },
            
            showErrorToUser(message) {
                showNotification('حدث خطأ: ' + message, 'error');
            },
            
            getLogs() {
                return this.logs;
            },
            
            clearLogs() {
                this.logs = [];
                localStorage.removeItem('errorLogs');
            },
            
            exportLogs() {
                const dataStr = JSON.stringify(this.logs, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `error-logs-${Date.now()}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            }
        };
        
        // تحميل السجلات المحفوظة
        try {
            const savedLogs = localStorage.getItem('errorLogs');
            if (savedLogs) {
                ErrorLogger.logs = JSON.parse(savedLogs);
            }
        } catch (e) {
            console.error('فشل تحميل سجلات الأخطاء:', e);
        }
        
        // التقاط الأخطاء العامة
        window.addEventListener('error', (event) => {
            ErrorLogger.log('CRITICAL', 'خطأ في JavaScript', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error ? event.error.stack : null
            });
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            ErrorLogger.log('ERROR', 'Promise مرفوض غير معالج', {
                reason: event.reason,
                promise: event.promise
            });
        });
        
        // ====================================
        // نظام الإشعارات
        // ====================================
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, duration);
        }
        
        // ====================================
        // نظام مراقبة الاتصال
        // ====================================
        const ConnectionMonitor = {
            isOnline: navigator.onLine,
            statusElement: null,
            
            init() {
                this.statusElement = document.getElementById('connectionStatus');
                this.updateStatus();
                
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateStatus();
                    showNotification('تم الاتصال بالإنترنت', 'success');
                    ErrorLogger.log('INFO', 'تم الاتصال بالإنترنت');
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateStatus();
                    showNotification('انقطع الاتصال بالإنترنت - سيتم العمل في وضع عدم الاتصال', 'warning');
                    ErrorLogger.log('WARNING', 'انقطع الاتصال بالإنترنت');
                });
            },
            
            updateStatus() {
                if (this.statusElement) {
                    this.statusElement.style.display = 'flex';
                    const statusText = document.getElementById('statusText');
                    
                    if (this.isOnline) {
                        this.statusElement.className = 'connection-status online';
                        statusText.textContent = 'متصل';
                    } else {
                        this.statusElement.className = 'connection-status offline';
                        statusText.textContent = 'غير متصل';
                    }
                    
                    // إخفاء المؤشر بعد 3 ثواني
                    setTimeout(() => {
                        this.statusElement.style.display = 'none';
                    }, 3000);
                }
            }
        };
        
        // ====================================
        // Service Worker
        // ====================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        ErrorLogger.log('INFO', 'Service Worker مسجل بنجاح', { scope: registration.scope });
                    })
                    .catch(error => {
                        ErrorLogger.log('ERROR', 'فشل تسجيل Service Worker', error);
                    });
            });
        }
        
        // ====================================
        // PWA Installation
        // ====================================
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            ErrorLogger.log('INFO', 'التطبيق جاهز للتثبيت');
            
            const installBtn = document.createElement('button');
            installBtn.textContent = '⬇️ تثبيت التطبيق على جهازك';
            installBtn.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#6366f1;color:#fff;padding:12px 32px;border-radius:16px;font-size:1.1em;z-index:9999;box-shadow:0 4px 12px #6366f155;border:none;cursor:pointer;';
            
            installBtn.onclick = async function() {
                installBtn.style.display = 'none';
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                ErrorLogger.log('INFO', `نتيجة التثبيت: ${outcome}`);
                deferredPrompt = null;
            };
            
            document.body.appendChild(installBtn);
        });
        
        // ====================================
        // قائمة الأقضية
        // ====================================
        const qadaList = [
            'الهاشمية',
            'الدبلة',
            'الحمزة',
            'الغربي',
            'القاسم',
            'الجربوعية',
            'العمادية',
            'أكياس',
            'أجبلة',
            'مركز المحافظة',
            'المحاويل'
        ];
        
        // ====================================
        // إعداد Firebase
        // ====================================
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "messageemeapp.firebaseapp.com",
            databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
            projectId: "messageemeapp",
            storageBucket: "messageemeapp.appspot.com",
            messagingSenderId: "255034474844",
            appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199",
            measurementId: "G-4QBEWRC583"
        };
        
        let db = null;
        let firebaseInitialized = false;
        
        try {
            if (typeof firebase === 'undefined') {
                throw new Error('مكتبة Firebase غير محملة');
            }
            
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                ErrorLogger.log('INFO', 'تم تهيئة Firebase بنجاح');
            }
            
            db = firebase.database();
            firebaseInitialized = true;
            
            // اختبار الاتصال
            db.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    ErrorLogger.log('INFO', 'متصل بقاعدة بيانات Firebase');
                    showNotification('متصل بقاعدة البيانات ✓', 'success', 3000);
                } else {
                    ErrorLogger.log('WARNING', 'غير متصل بقاعدة بيانات Firebase');
                }
            });
            
        } catch (error) {
            ErrorLogger.log('CRITICAL', 'فشل تهيئة Firebase', error);
            showNotification('تحذير: سيعمل التطبيق في وضع عدم الاتصال', 'warning', 5000);
        }
        
        // ====================================
        // دوال قاعدة البيانات
        // ====================================
        
        // حفظ مستخدم
        async function saveUser(user) {
            try {
                ErrorLogger.log('INFO', 'بدء حفظ المستخدم', { phone: user.phone, name: user.fullName });
                
                // حفظ محلي أولاً
                let users = JSON.parse(localStorage.getItem('users') || '[]');
                
                // التحقق من عدم وجود المستخدم مسبقاً
                const existingIndex = users.findIndex(u => u.phone === user.phone);
                if (existingIndex !== -1) {
                    users[existingIndex] = user;
                    ErrorLogger.log('INFO', 'تحديث بيانات مستخدم موجود');
                } else {
                    users.push(user);
                    ErrorLogger.log('INFO', 'إضافة مستخدم جديد');
                }
                
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                ErrorLogger.log('INFO', 'تم الحفظ المحلي بنجاح');
                
                // حفظ في Firebase إذا كان متاحاً
                if (firebaseInitialized && db) {
                    try {
                        await db.ref('users/' + user.phone).set(user);
                        ErrorLogger.log('INFO', 'تم الحفظ في Firebase بنجاح', { phone: user.phone });
                        showNotification('تم حفظ البيانات بنجاح ✓', 'success');
                    } catch (firebaseError) {
                        ErrorLogger.log('ERROR', 'فشل الحفظ في Firebase', firebaseError);
                        showNotification('تم الحفظ محلياً فقط (غير متصل بالسحابة)', 'warning');
                    }
                } else {
                    ErrorLogger.log('WARNING', 'Firebase غير متاح - تم الحفظ محلياً فقط');
                    showNotification('تم الحفظ محلياً (غير متصل بالإنترنت)', 'warning');
                }
                
                return true;
            } catch (error) {
                ErrorLogger.log('CRITICAL', 'فشل حفظ المستخدم', error);
                showNotification('حدث خطأ أثناء حفظ البيانات!', 'error');
                return false;
            }
        }
        
        // البحث عن مستخدم
        function findUser(name, phone) {
            try {
                ErrorLogger.log('INFO', 'البحث عن مستخدم', { name, phone });
                let users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.fullName === name && u.phone === phone);
                
                if (user) {
                    ErrorLogger.log('INFO', 'تم العثور على المستخدم');
                } else {
                    ErrorLogger.log('WARNING', 'لم يتم العثور على المستخدم');
                }
                
                return user;
            } catch (error) {
                ErrorLogger.log('ERROR', 'خطأ في البحث عن المستخدم', error);
                return null;
            }
        }
        
        // الحصول على بيانات مستخدم برقم الهاتف
        function getUserData(phone) {
            try {
                let users = JSON.parse(localStorage.getItem('users') || '[]');
                return users.find(u => u.phone === phone);
            } catch (error) {
                ErrorLogger.log('ERROR', 'خطأ في الحصول على بيانات المستخدم', error);
                return null;
            }
        }
        
        // مزامنة البيانات من Firebase
        async function syncFromFirebase() {
            if (!firebaseInitialized || !db) {
                ErrorLogger.log('WARNING', 'لا يمكن المزامنة - Firebase غير متاح');
                return;
            }
            
            try {
                ErrorLogger.log('INFO', 'بدء المزامنة من Firebase');
                const snapshot = await db.ref('users').once('value');
                
                if (snapshot.exists()) {
                    const firebaseUsers = snapshot.val();
                    const usersArray = Object.values(firebaseUsers);
                    
                    localStorage.setItem('users', JSON.stringify(usersArray));
                    ErrorLogger.log('INFO', `تمت المزامنة: ${usersArray.length} مستخدم`);
                    showNotification(`تم تحميل ${usersArray.length} مستخدم من السحابة`, 'success');
                } else {
                    ErrorLogger.log('INFO', 'لا توجد بيانات في Firebase');
                }
            } catch (error) {
                ErrorLogger.log('ERROR', 'فشلت المزامنة من Firebase', error);
                showNotification('فشل تحميل البيانات من السحابة', 'error');
            }
        }
        
        // ====================================
        // واجهات المستخدم
        // ====================================
        
        // واجهة تسجيل الدخول
        function renderLogin() {
            document.getElementById('app').innerHTML = `
                <h2>تسجيل الدخول</h2>
                <form id="loginForm">
                    <label>الاسم الثلاثي</label>
                    <input type="text" name="fullName" required placeholder="أدخل اسمك الثلاثي">
                    
                    <label>رقم الهاتف</label>
                    <input type="tel" name="phone" required placeholder="07xxxxxxxxx" pattern="[0-9]{11}">
                    
                    <button type="submit" id="loginBtn">
                        <span>دخول</span>
                    </button>
                </form>
                <span class="link" onclick="renderRegister()">ليس لديك حساب؟ أنشئ حساب جديد</span>
                
                <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border);">
                    <button onclick="syncFromFirebase()" style="background:var(--info);font-size:0.95em;">
                        🔄 تحديث من السحابة
                    </button>
                    <button onclick="showErrorLogs()" style="background:var(--dark);margin-top:12px;font-size:0.95em;">
                        📋 عرض سجل الأخطاء
                    </button>
                </div>
            `;
            
            document.getElementById('loginForm').onsubmit = async function(e) {
                e.preventDefault();
                const btn = document.getElementById('loginBtn');
                const originalContent = btn.innerHTML;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<div class="loading"></div>';
                    
                    const fullName = this.fullName.value.trim();
                    const phone = this.phone.value.trim();
                    
                    ErrorLogger.log('INFO', 'محاولة تسجيل الدخول', { fullName, phone });
                    
                    const user = findUser(fullName, phone);
                    
                    if (user) {
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        ErrorLogger.log('INFO', 'تم تسجيل الدخول بنجاح');
                        showNotification('مرحباً بك! ✓', 'success');
                        renderUserData(user);
                    } else {
                        ErrorLogger.log('WARNING', 'فشل تسجيل الدخول - بيانات خاطئة');
                        showNotification('لا يوجد مستخدم بهذه البيانات!', 'error');
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }
                } catch (error) {
                    ErrorLogger.log('ERROR', 'خطأ في تسجيل الدخول', error);
                    showNotification('حدث خطأ أثناء تسجيل الدخول', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            };
        }
        
        // واجهة إنشاء حساب جديد
        function renderRegister() {
            document.getElementById('app').innerHTML = `
                <h2>إنشاء حساب جديد</h2>
                <form id="registerForm">
                    <label>الاسم الثلاثي <span style="color:var(--danger)">*</span></label>
                    <input type="text" name="fullName" required placeholder="أدخل اسمك الكامل">
                    
                    <label>رقم الهاتف <span style="color:var(--danger)">*</span></label>
                    <input type="tel" name="phone" required placeholder="07xxxxxxxxx" pattern="[0-9]{11}">
                    
                    <label>تاريخ الميلاد <span style="color:var(--danger)">*</span></label>
                    <input type="date" name="birthDate" required>
                    
                    <label>القضاء <span style="color:var(--danger)">*</span></label>
                    <select name="district" required>
                        <option value="">-- اختر القضاء --</option>
                        ${qadaList.map(q => `<option value="${q}">${q}</option>`).join('')}
                    </select>
                    
                    <label>الجنس <span style="color:var(--danger)">*</span></label>
                    <select name="gender" required>
                        <option value="">-- اختر --</option>
                        <option value="ذكر">ذكر</option>
                        <option value="أنثى">أنثى</option>
                    </select>
                    
                    <label>ملاحظات</label>
                    <input type="text" name="notes" placeholder="اختياري">
                    
                    <label>الصورة الأمامية <span style="color:var(--danger)">*</span></label>
                    <input type="file" name="front" accept="image/*" required>
                    
                    <label>الصورة الخلفية <span style="color:var(--danger)">*</span></label>
                    <input type="file" name="back" accept="image/*" required>
                    
                    <button type="submit" id="registerBtn">
                        <span>إنشاء الحساب</span>
                    </button>
                </form>
                <span class="link" onclick="renderLogin()">لديك حساب؟ تسجيل الدخول</span>
            `;
            
            document.getElementById('registerForm').onsubmit = async function(e) {
                e.preventDefault();
                const btn = document.getElementById('registerBtn');
                const originalContent = btn.innerHTML;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<div class="loading"></div> <span>جاري الحفظ...</span>';
                    
                    const fullName = this.fullName.value.trim();
                    const phone = this.phone.value.trim();
                    const birthDate = this.birthDate.value;
                    const district = this.district.value;
                    const gender = this.gender.value;
                    const notes = this.notes.value.trim();
                    const frontFile = this.front.files[0];
                    const backFile = this.back.files[0];
                    
                    if (!frontFile || !backFile) {
                        throw new Error('يرجى رفع الصور المطلوبة');
                    }
                    
                    // التحقق من عدم وجود المستخدم مسبقاً
                    const existingUser = getUserData(phone);
                    if (existingUser) {
                        throw new Error('هذا الرقم مسجل مسبقاً!');
                    }
                    
                    ErrorLogger.log('INFO', 'بدء إنشاء حساب جديد', { fullName, phone });
                    
                    // قراءة الصور
                    const frontImage = await readFileAsDataURL(frontFile);
                    const backImage = await readFileAsDataURL(backFile);
                    
                    const user = {
                        fullName,
                        phone,
                        birthDate,
                        district,
                        gender,
                        notes,
                        images: {
                            front: frontImage,
                            back: backImage
                        },
                        profileImg: null,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    const success = await saveUser(user);
                    
                    if (success) {
                        ErrorLogger.log('INFO', 'تم إنشاء الحساب بنجاح');
                        showNotification('تم إنشاء الحساب بنجاح! ✓', 'success');
                        setTimeout(() => renderUserData(user), 500);
                    } else {
                        throw new Error('فشل حفظ البيانات');
                    }
                    
                } catch (error) {
                    ErrorLogger.log('ERROR', 'خطأ في إنشاء الحساب', error);
                    showNotification(error.message || 'حدث خطأ أثناء إنشاء الحساب', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            };
        }
        
        // دالة مساعدة لقراءة الملفات
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        }
        
        // عرض بيانات المستخدم
        function renderUserData(user) {
            document.getElementById('app').innerHTML = `
                <h2>بيانات المستخدم</h2>
                <div class="user-data">
                    <div style="text-align:center; margin-bottom:12px; position:relative;">
                        <label for="profileInput" style="cursor:pointer;display:inline-block;">
                            <img id="profileImg" src="${user.profileImg || (user.images?.front || '')}" alt="صورة المستخدم" 
                                 style="width:90px;height:90px;border-radius:50%;object-fit:cover;border:3px dashed var(--primary);box-shadow:var(--shadow-md);">
                            ${!user.profileImg ? `<div style="position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);color:var(--primary);font-size:0.85em;font-weight:bold;background:#fff;padding:2px 10px;border-radius:12px;box-shadow:0 2px 8px #6366f133;">أضف صورة انتخابك هنا</div>` : ''}
                        </label>
                        <input type="file" id="profileInput" accept="image/*" capture="environment" style="display:none">
                    </div>
                    
                    <div class="flip-card" id="flipCard">
                        <div class="flip-card-inner">
                            <div class="flip-card-front">
                                <img src="${user.images?.front || ''}" alt="الصورة الأمامية">
                            </div>
                            <div class="flip-card-back">
                                <img src="${user.images?.back || ''}" alt="الصورة الخلفية">
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-info">
                        <div><strong>الاسم الثلاثي:</strong> <span>${user.fullName}</span></div>
                        <div><strong>رقم الهاتف:</strong> <span>${user.phone}</span></div>
                        <div><strong>تاريخ الميلاد:</strong> <span>${user.birthDate}</span></div>
                        <div><strong>القضاء:</strong> <span>${user.district}</span></div>
                        <div><strong>الجنس:</strong> <span>${user.gender}</span></div>
                        ${user.notes ? `<div><strong>ملاحظات:</strong> <span>${user.notes}</span></div>` : ''}
                    </div>
                </div>
                
                <button onclick="logoutUser()" style="margin-top:24px;background:var(--danger);">
                    تسجيل خروج
                </button>
                
                <button onclick="showErrorLogs()" style="margin-top:12px;background:var(--dark);font-size:0.95em;">
                    📋 عرض سجل الأخطاء
                </button>
            `;
            
            // إعداد أحداث الصفحة
            setTimeout(() => {
                // حدث قلب البطاقة
                const flipCard = document.getElementById('flipCard');
                if (flipCard) {
                    flipCard.addEventListener('click', function() {
                        flipCard.classList.toggle('flipped');
                    });
                }
                
                // حدث رفع صورة الملف الشخصي
                const profileInput = document.getElementById('profileInput');
                const profileImg = document.getElementById('profileImg');
                
                if (profileInput && profileImg) {
                    profileInput.onchange = async function(e) {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        try {
                            ErrorLogger.log('INFO', 'رفع صورة الملف الشخصي');
                            const imageData = await readFileAsDataURL(file);
                            
                            profileImg.src = imageData;
                            user.profileImg = imageData;
                            user.updatedAt = new Date().toISOString();
                            
                            // حفظ التحديث
                            await saveUser(user);
                            showNotification('تم تحديث صورة الملف الشخصي ✓', 'success');
                            
                        } catch (error) {
                            ErrorLogger.log('ERROR', 'خطأ في رفع الصورة', error);
                            showNotification('فشل رفع الصورة', 'error');
                        }
                    };
                }
            }, 100);
        }
        
        // تسجيل الخروج
        function logoutUser() {
            try {
                ErrorLogger.log('INFO', 'تسجيل خروج المستخدم');
                localStorage.removeItem('currentUser');
                showNotification('تم تسجيل الخروج', 'info');
                renderLogin();
            } catch (error) {
                ErrorLogger.log('ERROR', 'خطأ في تسجيل الخروج', error);
            }
        }
        
        // عرض سجل الأخطاء
        function showErrorLogs() {
            const logs = ErrorLogger.getLogs();
            
            if (logs.length === 0) {
                showNotification('لا توجد أخطاء مسجلة ✓', 'success');
                return;
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            overlay.onclick = () => {
                document.body.removeChild(overlay);
                document.body.removeChild(errorDetails);
            };
            
            const errorDetails = document.createElement('div');
            errorDetails.className = 'error-details';
            errorDetails.innerHTML = `
                <h3 style="text-align:right;direction:rtl;">📋 سجل الأخطاء (${logs.length})</h3>
                <div style="margin-bottom:16px;display:flex;gap:8px;">
                    <button onclick="ErrorLogger.exportLogs()" style="flex:1;padding:8px;background:var(--info);color:white;border:none;border-radius:8px;cursor:pointer;">
                        تصدير
                    </button>
                    <button onclick="ErrorLogger.clearLogs();location.reload();" style="flex:1;padding:8px;background:var(--danger);color:white;border:none;border-radius:8px;cursor:pointer;">
                        مسح
                    </button>
                </div>
                <pre>${JSON.stringify(logs, null, 2)}</pre>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(errorDetails);
        }
        
        // ====================================
        // بدء التطبيق
        // ====================================
        
        window.addEventListener('load', async function() {
            try {
                // تهيئة مراقب الاتصال
                ConnectionMonitor.init();
                
                ErrorLogger.log('INFO', 'بدء تحميل التطبيق');
                
                // إخفاء شاشة البداية
                setTimeout(function() {
                    document.getElementById('splash').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                }, 1800);
                
                // التحقق من المستخدم الحالي
                const currentUser = localStorage.getItem('currentUser');
                
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    ErrorLogger.log('INFO', 'مستخدم مسجل الدخول موجود', { phone: user.phone });
                    renderUserData(user);
                } else {
                    // محاولة المزامنة من Firebase
                    if (firebaseInitialized && navigator.onLine) {
                        await syncFromFirebase();
                    }
                    renderLogin();
                }
                
                ErrorLogger.log('INFO', 'اكتمل تحميل التطبيق بنجاح');
                
            } catch (error) {
                ErrorLogger.log('CRITICAL', 'خطأ في بدء التطبيق', error);
                document.getElementById('splash').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                renderLogin();
            }
        });
        
    </script>
</body>
</html>
